</head>

<body class="g-sidenav-show   bg-gray-100">
    <div class="min-height-300 bg-primary position-absolute w-100"></div>
    {{> __dsidenav}}
    <main class="main-content position-relative border-radius-lg ">
        {{> __dashnavbar}}

        <div class="row align-items-center mb-3">
            <div class="col-lg-6">
                <h5 class="text-white mb-0">Cash Buyers</h5>
                <small class="text-light opacity-75">Search and filter your buyer list instantly.</small>
            </div>
            <div class="col-lg-6 mt-3 mt-lg-0">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="fa fa-search text-muted"></i></span>
                    <input id="cashbuyer-search" type="search" class="form-control border-start-0" placeholder="Search by name, area, property type, or IP">
                </div>
            </div>
        </div>

        <div id="cashbuyer-list" class="row g-3">
            {{#each cashbuyer}}
            <div class="col-md-4 p-2 cashbuyer-card" data-search="{{this.FullName}} {{this.PreferredAreas}} {{this.PropertyType}} {{this.CashBuyerIP}} {{this.CellPhone}} {{this.Email}}">
                <div class="buyer-card card h-100 border-0 shadow-sm overflow-hidden">
                    <div class="buyer-card__stripe"></div>
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex align-items-center gap-3">
                            <div class="buyer-avatar">
                                {{#if this.ProofOfFundsFile}}
                                <img src="/{{this.ProofOfFundsFile}}" alt="proof" class="img-fluid rounded-circle">
                                {{else}}
                                <div class="buyer-avatar__placeholder">
                                    <i class="ni ni-single-02"></i>
                                </div>
                                {{/if}}
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-start justify-content-between gap-2">
                                    <div>
                                        <h6 class="mb-1 text-truncate">{{this.FullName}}</h6>
                                        <small class="text-muted">{{this.YearsInBusiness}} in business</small>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <a href="mailto:{{this.Email}}" class="btn btn-light btn-sm buyer-action" title="Email"><i class="ni ni-email-83"></i></a>
                                        <a href="sms:{{this.CellPhone}}" class="btn btn-light btn-sm buyer-action" title="SMS"><i class="ni ni-send"></i></a>
                                        <a href="tel:{{this.CellPhone}}" class="btn btn-light btn-sm buyer-action" title="Call"><i class="fa-solid fa-phone"></i></a>
                                    </div>
                                </div>
                                <div class="mt-2 d-flex flex-wrap gap-2">
                                    <span class="pill pill-success" data-bs-toggle="tooltip" data-bs-placement="top" title="{{this.FundingInPlace}}">Cash Ready</span>
                                    <span class="pill pill-info" data-bs-toggle="tooltip" data-bs-placement="top" title="{{this.ProofOfFunds}}">Proof Verified</span>
                                    <span class="pill pill-secondary" data-bs-toggle="tooltip" data-bs-placement="top" title="{{this.Quickly}}">Closes Fast</span>
                                </div>
                            </div>
                        </div>

                        <div class="buyer-meta mt-3">
                            <div class="buyer-meta__item">
                                <span class="meta-icon text-success"><i class="ni ni-money-coins"></i></span>
                                <div>
                                    <div class="meta-label">Price Range</div>
                                    <div class="meta-value price-range" data-raw="{{this.PriceRanges}}">{{this.PriceRanges}}</div>
                                </div>
                            </div>
                            <div class="buyer-meta__item">
                                <span class="meta-icon text-info"><i class="fa-solid fa-map-location-dot"></i></span>
                                <div>
                                    <div class="meta-label">Preferred Areas</div>
                                    <div class="meta-value" title="{{this.PreferredAreas}}">{{this.PreferredAreas}}</div>
                                </div>
                            </div>
                            <div class="buyer-meta__item">
                                <span class="meta-icon text-primary"><i class="fa-solid fa-house-chimney"></i></span>
                                <div>
                                    <div class="meta-label">Property Type</div>
                                    <div class="meta-value">{{this.PropertyType}}</div>
                                </div>
                            </div>
                            <div class="buyer-meta__item">
                                <span class="meta-icon text-muted"><i class="fa-solid fa-network-wired"></i></span>
                                <div>
                                    <div class="meta-label">IP Address</div>
                                    <div class="meta-value"><a href="https://ipinfo.io/{{this.CashBuyerIP}}" target="_blank">{{this.CashBuyerIP}}</a></div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-auto pt-3 d-flex align-items-center justify-content-between gap-2">
                            {{#if this.ProofOfFundsFile}}
                            <a href="/{{this.ProofOfFundsFile}}" class="btn btn-soft border-0 flex-grow-1" target="_blank">View Proof</a>
                            {{/if}}
                            <a href="javascript:;" data-id="{{this.buyerID}}" class="buyer-detail btn btn-primary flex-grow-1">Details <i class="ni ni-collection ms-1"></i></a>
                        </div>
                    </div>
                </div>
            </div>
            {{/each}}
        </div>
        <div id="cashbuyer-empty" class="text-center text-muted py-4 d-none">
            <i class="fa fa-search mb-2"></i>
            <p class="mb-0">No buyers match your search.</p>
        </div>
                <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
                <script>const cashbuyers = {{{ json cashbuyer }}};
                        document.addEventListener('DOMContentLoaded', function () {
                                // Build pretty modal shell once
                                const modalContainer = document.createElement('div');
                                modalContainer.innerHTML = `
                                <div class="modal fade" id="buyerDetailModal" tabindex="-1" aria-labelledby="buyerDetailModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg modal-dialog-centered">
                                        <div class="modal-content buyer-modal">
                                            <div class="modal-header border-0 pb-0">
                                                <div>
                                                    <p class="modal-kicker mb-1">Buyer profile</p>
                                                    <h5 class="modal-title" id="buyerDetailModalLabel">Details</h5>
                                                </div>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body" id="buyerDetailBody"></div>
                                            <div class="modal-footer border-0 pt-0">
                                                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>`;
                                document.body.appendChild(modalContainer);

                                const buyerModalEl = document.getElementById('buyerDetailModal');
                                const buyerModal = new bootstrap.Modal(buyerModalEl);

                                function fmtPriceRange(raw) {
                                    if (!raw) return '';
                                    const nums = (String(raw).match(/\d+/g) || []).map(function (n) { return Number(n); });
                                    if (nums.length >= 2) {
                                        function fmt(n) { return '$' + n.toLocaleString(); }
                                        return fmt(nums[0]) + ' - ' + fmt(nums[1]);
                                    }
                                    return raw;
                                }

                                function chip(label, value, tone) {
                                    if (!value) return '';
                                    return `<span class="chip chip-${tone}"><strong>${label}:</strong> ${value}</span>`;
                                }

                                function metaItem(icon, label, value) {
                                    if (!value && value !== 0) return '';
                                    return `
                                        <div class="buyer-modal__meta">
                                            <span class="meta-icon"><i class="${icon}"></i></span>
                                            <div>
                                                <div class="meta-label">${label}</div>
                                                <div class="meta-value">${value}</div>
                                            </div>
                                        </div>
                                    `;
                                }

                                document.querySelectorAll('.buyer-detail').forEach(button => {
                                        button.addEventListener('click', function () {
                                                const buyerID = this.getAttribute('data-id');
                                                const buyerData = cashbuyers.find(buyer => String(buyer.buyerID) === String(buyerID));
                                                if (buyerData) {
                                                        const name = buyerData.FullName || 'Buyer';
                                                        const years = buyerData.YearsInBusiness || '';
                                                        const email = buyerData.Email || '';
                                                        const phone = buyerData.CellPhone || '';
                                                        const priceRange = fmtPriceRange(buyerData.PriceRanges);
                                                        const description = buyerData.AdditionalComments || buyerData.Description || '';

                                                        const proofImg = buyerData.ProofOfFundsFile ? `<img src="/${buyerData.ProofOfFundsFile}" class="img-fluid rounded w-100" style="max-height:220px;object-fit:cover;" alt="Proof of funds"/>` : '<div class="buyer-modal__proof-placeholder">No proof uploaded</div>';

                                                        const chips = [
                                                            chip('Funding', buyerData.FundingInPlace, 'success'),
                                                            chip('Proof', buyerData.ProofOfFunds, 'info'),
                                                            chip('Speed', buyerData.Quickly, 'purple')
                                                        ].join('');

                                                        const contactBtns = `
                                                            <div class="d-flex gap-2 flex-wrap">
                                                                ${email ? `<a href="mailto:${email}" class="btn btn-outline-primary btn-sm">Email</a>` : ''}
                                                                ${phone ? `<a href="sms:${phone}" class="btn btn-outline-primary btn-sm">SMS</a>` : ''}
                                                                ${phone ? `<a href="tel:${phone}" class="btn btn-primary btn-sm">Call</a>` : ''}
                                                                ${email ? `<button class="btn btn-light btn-sm copy-btn" data-copy-text="${email}">Copy Email</button>` : ''}
                                                                ${phone ? `<button class="btn btn-light btn-sm copy-btn" data-copy-text="${phone}">Copy Phone</button>` : ''}
                                                            </div>
                                                        `;

                                                        const metaGrid = `
                                                            ${metaItem('ni ni-money-coins text-success', 'Price Range', priceRange || buyerData.PriceRanges)}
                                                            ${metaItem('fa-solid fa-map-location-dot text-info', 'Preferred Areas', buyerData.PreferredAreas)}
                                                            ${metaItem('fa-solid fa-house-chimney text-primary', 'Property Type', buyerData.PropertyType)}
                                                            ${metaItem('fa-solid fa-network-wired text-muted', 'IP Address', buyerData.CashBuyerIP ? `<a href="https://ipinfo.io/${buyerData.CashBuyerIP}" target="_blank">${buyerData.CashBuyerIP}</a>` : '')}
                                                        `;

                                                        const extraTable = Object.entries(buyerData).reduce(function (acc, [key, value]) {
                                                            if (!value && value !== 0) return acc;
                                                            const exclude = ['ProofOfFundsFile','FullName','YearsInBusiness','Email','CellPhone','buyerID','PriceRanges','PreferredAreas','PropertyType','CashBuyerIP','FundingInPlace','ProofOfFunds','Quickly','AdditionalComments','Description'];
                                                            if (exclude.includes(key)) return acc;
                                                            acc += `<tr><th>${key}</th><td>${value}</td></tr>`;
                                                            return acc;
                                                        }, '');

                                                        const bodyHTML = `
                                                            <div class="buyer-modal__header">
                                                                <div class="buyer-modal__avatar">
                                                                    ${buyerData.ProofOfFundsFile ? `<img src="/${buyerData.ProofOfFundsFile}" alt="${name}">` : '<span class="placeholder-initials">'+ (name.slice(0,1) || 'B') +'</span>'}
                                                                </div>
                                                                <div class="flex-grow-1">
                                                                    <h5 class="mb-1">${name}</h5>
                                                                    <div class="text-muted small">${years ? years + ' in business' : ''}</div>
                                                                    <div class="mt-2 d-flex flex-wrap gap-2">${chips}</div>
                                                                </div>
                                                            </div>
                                                            <div class="buyer-modal__split">
                                                                <div class="buyer-modal__left">
                                                                    <div class="buyer-modal__panel">
                                                                        <div class="buyer-modal__panel-title">Proof of Funds</div>
                                                                        ${proofImg}
                                                                    </div>
                                                                    <div class="buyer-modal__panel">
                                                                        <div class="buyer-modal__panel-title">Contact</div>
                                                                        ${contactBtns}
                                                                    </div>
                                                                </div>
                                                                <div class="buyer-modal__right">
                                                                    <div class="buyer-modal__panel">
                                                                        <div class="buyer-modal__panel-title">Summary</div>
                                                                        <div class="buyer-modal__grid">
                                                                            ${metaGrid}
                                                                        </div>
                                                                    </div>
                                                                    ${description ? `<div class="buyer-modal__panel"><div class="buyer-modal__panel-title">Description</div><p class="mb-0 text-muted">${description}</p></div>` : ''}
                                                                    ${extraTable ? `<div class="buyer-modal__panel"><div class="buyer-modal__panel-title">Additional Fields</div><div class="table-responsive"><table class="table table-sm mb-0"><tbody>${extraTable}</tbody></table></div></div>` : ''}
                                                                </div>
                                                            </div>
                                                        `;

                                                        document.getElementById('buyerDetailBody').innerHTML = bodyHTML;
                                                        // Attach copy handlers
                                                        try {
                                                            document.querySelectorAll('#buyerDetailBody .copy-btn').forEach(function(b){
                                                                const txt = b.getAttribute('data-copy-text');
                                                                window.attachCopyHandler(b, txt);
                                                            });
                                                        } catch (e) {}
                                                        buyerModal.show();
                                                } else {
                                                        Swal.fire({title: 'Error', text: `Buyer data not found for ID: ${buyerID}`, icon: 'error'});
                                                }
                                        });
                                });

                                // Simple search/filter
                                const searchInput = document.getElementById('cashbuyer-search');
                                const cards = Array.from(document.querySelectorAll('[data-search]'));
                                const emptyState = document.getElementById('cashbuyer-empty');
                                function filterCards() {
                                    const term = (searchInput.value || '').toLowerCase();
                                    let visibleCount = 0;
                                    cards.forEach(card => {
                                        const matchText = (card.getAttribute('data-search') || '').toLowerCase();
                                        const show = !term || matchText.includes(term);
                                        card.style.display = show ? '' : 'none';
                                        if (show) visibleCount += 1;
                                    });
                                    if (emptyState) emptyState.classList.toggle('d-none', visibleCount !== 0);
                                }
                                if (searchInput) {
                                    searchInput.addEventListener('input', filterCards);
                                }
                                filterCards();
                        });
                </script>
        <style>
            /* Card hover and visual polish */
            .cashbuyer-card { min-width: 320px; }
            .buyer-card { border-radius: 14px; background: linear-gradient(160deg, #f8fafc, #eef2ff); position: relative; transition: transform .2s ease, box-shadow .2s ease; min-height: 460px; }
            .buyer-card:hover { transform: translateY(-6px); box-shadow: 0 16px 40px rgba(18,38,63,.16); }
            .buyer-card__stripe { height: 6px; width: 100%; background: linear-gradient(120deg, #22c55e, #0ea5e9); }
            .buyer-avatar { width: 56px; height: 56px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; box-shadow: inset 0 1px 2px rgba(0,0,0,.06); overflow: hidden; }
            .buyer-avatar img { width: 100%; height: 100%; object-fit: cover; }
            .buyer-avatar__placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #64748b; font-size: 1.25rem; }
            .buyer-action { border-radius: 50%; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; border: 1px solid #e2e8f0; }
            .pill { padding: 6px 10px; border-radius: 999px; font-size: 0.75rem; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; }
            .pill-success { background: rgba(34,197,94,.12); color: #15803d; }
            .pill-info { background: rgba(14,165,233,.12); color: #0369a1; }
            .pill-secondary { background: rgba(99,102,241,.12); color: #4338ca; }
            .buyer-meta { display: grid; grid-template-columns: 1fr; gap: 10px; }
            .buyer-meta__item { background: rgba(255,255,255,.7); border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px 12px; display: flex; align-items: center; gap: 10px; }
            .meta-icon { font-size: 1rem; width: 28px; height: 28px; border-radius: 8px; background: #f8fafc; display: inline-flex; align-items: center; justify-content: center; }
            .meta-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.02em; color: #94a3b8; margin-bottom: 2px; }
            .meta-value { font-size: 0.95rem; font-weight: 600; color: #0f172a; white-space: normal; word-break: break-word; }
            .buyer-detail { min-width: 110px; }
            .price-range { font-weight:700; color:#0d6efd; }
            #cashbuyer-search { border-radius: 0 0.375rem 0.375rem 0; }
            #cashbuyer-empty i { color: #adb5bd; }
            .btn-soft { background: rgba(14,165,233,.08); color: #0369a1; }
            /* Modal polish */
            .buyer-modal { border-radius: 16px; overflow: hidden; }
            .buyer-modal .modal-header { background: linear-gradient(120deg, #22c55e, #0ea5e9); color: #fff; }
            .buyer-modal .modal-title { color: #fff; }
            .modal-kicker { text-transform: uppercase; letter-spacing: 0.08em; font-size: 0.7rem; opacity: .85; }
            .buyer-modal__header { display:flex; gap:12px; align-items:center; margin-bottom:16px; }
            .buyer-modal__avatar { width:64px; height:64px; border-radius:12px; background:#e2e8f0; overflow:hidden; display:flex; align-items:center; justify-content:center; font-weight:700; color:#475569; }
            .buyer-modal__avatar img { width:100%; height:100%; object-fit:cover; }
            .placeholder-initials { font-size:1.1rem; }
            .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:.8rem; font-weight:600; }
            .chip-success { background: rgba(34,197,94,.12); color:#15803d; }
            .chip-info { background: rgba(14,165,233,.12); color:#0369a1; }
            .chip-purple { background: rgba(99,102,241,.12); color:#4338ca; }
            .buyer-modal__split { display:grid; grid-template-columns: 1fr; gap:12px; }
            .buyer-modal__panel { background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:12px; }
            .buyer-modal__panel-title { font-weight:700; font-size:.95rem; color:#0f172a; margin-bottom:10px; }
            .buyer-modal__proof-placeholder { background:#e2e8f0; color:#475569; border-radius:8px; padding:16px; text-align:center; }
            .buyer-modal__grid { display:grid; grid-template-columns:1fr; gap:10px; }
            .buyer-modal__meta { display:flex; gap:10px; align-items:flex-start; padding:8px; border:1px solid #e2e8f0; border-radius:10px; background:#fff; }
            @media (min-width: 768px) {
                .buyer-meta { grid-template-columns: repeat(2, 1fr); }
                .buyer-modal__split { grid-template-columns: 1fr 1.4fr; }
                .buyer-modal__grid { grid-template-columns: repeat(2, 1fr); }
            }
        </style>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Initialize Bootstrap tooltips if bootstrap is available
                try {
                    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el); });
                } catch (e) {}

                // Pretty-format price ranges like "100000 - 750000" -> "$100,000 - $750,000"
                try {
                    document.querySelectorAll('.price-range').forEach(function (el) {
                        var raw = el.getAttribute('data-raw') || el.textContent || '';
                        var nums = (raw.match(/\d+/g) || []).map(function(n){ return Number(n); });
                        if (nums.length >= 2) {
                            function fmt(n){ return '$' + n.toLocaleString(); }
                            el.textContent = fmt(nums[0]) + ' - ' + fmt(nums[1]);
                        }
                    });
                } catch (e) { console.error('price format', e); }

                // Copy-to-clipboard helper used in modal
                window.attachCopyHandler = function(button, text) {
                    if (!button) return;
                    button.addEventListener('click', function () {
                        navigator.clipboard && navigator.clipboard.writeText(text).then(function(){
                            button.classList.add('btn-success');
                            setTimeout(()=>button.classList.remove('btn-success'),1200);
                        }).catch(()=>{});
                    });
                };
            });
        </script>
