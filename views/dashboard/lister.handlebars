<head>

<body class="g-sidenav-show bg-gray-100">
  <div class="min-height-300 bg-primary position-absolute w-100"></div>
  {{> __dsidenav}}
  <main class="main-content position-relative border-radius-lg ">
    {{> __dashnavbar}}
    <div class="row g-3">
      {{#each listings}}
      <div class="col-12 mb-3">
        <div class="card h-100 shadow-sm listing-card" data-id="{{this.listingId}}">
          <div class="row g-0 h-100">
            <div class="col-5 col-md-4">
                    <div class="card-img-left">
                      {{#if this.PhotoFile}}
                        <img src="{{firstImage this.PhotoFile}}" alt="{{this.Title}}" class="card-img-element"/>
                      {{else}}
                        {{#if this.PhotoURL}}
                          <img src="{{sanitize this.PhotoURL}}" alt="{{this.Title}}" class="card-img-element"/>
                        {{else}}
                          <div class="card-img-placeholder"></div>
                        {{/if}}
                      {{/if}}
                    </div>
                  </div>
            <div class="col-7 col-md-8">
              <div class="card-body d-flex flex-column h-100">
                <div class="d-flex justify-content-between align-items-start">
                  <h6 class="mb-1 text-truncate listing-title" title="{{this.Title}}">{{this.Title}}</h6>
                  <div class="text-end">
                    <div class="text-primary fw-bold listing-price">${{this.AskingPrice}}</div>
                    <div class="text-muted small">{{formatDate this.SubmitDate}}</div>
                  </div>
                </div>

                <p class="mb-1 text-muted small text-truncate listing-address">{{this.PropertyAddress}}</p>

                <div class="d-flex gap-2 mb-2 mt-auto align-items-center">
                  <span class="badge bg-info text-dark listing-bedrooms"><i class="flaticon-bed"></i> {{this.Bedrooms}}</span>
                  <span class="badge bg-info text-dark listing-bathrooms"><i class="flaticon-bathtub"></i> {{this.Bathrooms}}</span>
                  <span class="badge bg-light text-muted listing-sqft">{{formatSqft this.SquareFootage this.FloorArea}}</span>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-2">
                  <div class="btn-group flex-wrap" role="group">
                    <button class="btn btn-sm btn-outline-primary listing-detail" data-id="{{this.listingId}}">Details</button>
                    <a class="btn btn-sm btn-outline-secondary" href="tel:{{this.ContactPhone}}">Call</a>
                    <a class="btn btn-sm btn-outline-secondary" href="mailto:{{this.ContactEmail}}">Email</a>
                    <a class="btn btn-sm btn-outline-primary edit-listing" data-id="{{this.listingId}}" href="/forms/listing?editId={{this.listingId}}">Edit</a>
                    <button class="btn btn-sm btn-outline-danger delete-listing" data-id="{{this.listingId}}">Delete</button>
                  </div>
                  <div class="d-flex align-items-center">
                    <div class="d-flex align-items-center">
                      <!-- Availability button (AJAX) -->
                      <button
                        class="btn btn-sm availability-btn me-2 {{#if this.Available}}btn-success{{else}}btn-outline-secondary{{/if}}"
                        data-id="{{this.listingId}}"
                        data-available="{{this.Available}}"
                        aria-pressed="false"
                        title="Toggle availability">
                        {{#if this.Available}}Available{{else}}Unavailable{{/if}}
                      </button>

                      {{#if this.IsPro}}
                        <span class="badge bg-warning text-dark me-2">PRO</span>
                      {{/if}}

                      <button class="btn btn-sm btn-primary copy-link" data-id="{{this.listingId}}">Link</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {{/each}}
    </div>

    <style>
      /* Modern small card image */
  .listing-card { border-radius: 12px; overflow: hidden; transition: transform .12s ease, box-shadow .12s ease; display:flex; }
  .listing-card:hover { transform: translateY(-6px); box-shadow: 0 8px 28px rgba(22,28,45,0.12); }
  /* Image column: force cover and keep rounded left corners */
  .card-img-left { width:100%; height:100%; min-height:180px; position:relative; border-top-left-radius:12px; border-bottom-left-radius:12px; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#f6f7fb; }
  /* Use an actual <img> so we can control object-fit and avoid cropping when undesired */
  .card-img-element{ width:100%; height:100%; object-fit:contain; display:block; }
  .card-img-left::after { content: ''; position:absolute; inset:0; pointer-events:none; background:linear-gradient(180deg,rgba(0,0,0,0.0),rgba(0,0,0,0.08)); }
  .card-img-placeholder{ width:100%; height:100%; background:linear-gradient(90deg,#eceef6,#f7f9fc); }
  .text-truncate{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  /* Make title and address use multi-line clamp to avoid awkward truncation */
  .card-body h6{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  .card-body p { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
      .availability-btn{ min-width:96px; }
      .availability-btn.btn-success{ color:#fff; }
      .availability-btn.btn-outline-secondary{ background:transparent; border:1px solid rgba(0,0,0,0.06); }
      .card-body h6{ font-weight:600; }
      .badge.bg-info{ background:#e7f3ff; color:#0b63d6; }
      /* Ensure consistent card height and remove inner gutters */
      .listing-card .row.g-0 { height:100%; }
      .listing-card .col-5, .listing-card .col-7 { padding:0; }
  .listing-card .card-body { padding:14px; }
  @media (max-width:767px){
    .card-img-left{ min-height:160px; }
  }
    </style>

    <!-- Edit Listing Modal -->
    <div class="modal fade" id="editListingModal" tabindex="-1" aria-labelledby="editListingModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editListingModalLabel">Edit Listing</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="editListingForm" novalidate>
              <input type="hidden" id="editListingId">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Title</label>
                  <input type="text" class="form-control" id="editTitle" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Asking Price</label>
                  <input type="number" class="form-control" id="editAskingPrice" step="0.01">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Address</label>
                  <input type="text" class="form-control" id="editAddress">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Bedrooms</label>
                  <input type="number" class="form-control" id="editBedrooms" min="0">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Bathrooms</label>
                  <input type="number" class="form-control" id="editBathrooms" min="0">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Square Footage</label>
                  <input type="number" class="form-control" id="editSqft" min="0">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Photo URL</label>
                  <input type="text" class="form-control" id="editPhotoURL" placeholder="https://...">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Upload New Photos</label>
                  <input type="file" class="form-control" id="editPhotoFiles" name="PhotoFiles" accept="image/*" multiple>
                  <small class="text-muted d-block mt-1">Select up to 30 images to add to this listing.</small>
                  <div id="editPhotoPreview" class="mt-2 d-flex gap-2 flex-wrap"></div>
                </div>
                <div class="col-md-4 d-flex align-items-center">
                  <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="editAvailable">
                    <label class="form-check-label" for="editAvailable">Available</label>
                  </div>
                </div>
                <div class="col-12">
                  <label class="form-label">Current Photos</label>
                  <div id="editCurrentPhotos" class="border rounded p-2 d-flex gap-2 flex-wrap bg-light" style="min-height:90px;">
                    <span class="text-muted small">No photos uploaded yet.</span>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="saveListingBtn">Save changes</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function(){

        // Client-side sanitizers for modal display
        function decodeHtmlEntities(str){
          if(str === null || str === undefined) return '';
          try{
            var txt = document.createElement('textarea');
            txt.innerHTML = String(str);
            return txt.value;
          } catch(e){ return String(str); }
        }

        function escapeHtml(str){
          return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\"/g, '&quot;')
            .replace(/'/g, '&#39;');
        }

        function sanitizeDisplay(input){
          if(input === null || input === undefined) return '';
          var s = decodeHtmlEntities(input);
          // Normalize backslashes and fullwidth slashes to forward slash
          s = s.replace(/[\\\uFF0F]/g, '/');
          return escapeHtml(s);
        }

        // Use for src/href attribute values (do not HTML-escape here)
        function sanitizeAttribute(input){
          if(input === null || input === undefined) return '';
          var s = decodeHtmlEntities(input);
          s = s.replace(/[\\\uFF0F]/g, '/');
          try{ return encodeURI(s); } catch(e){ return s; }
        }

        function parsePhotoList(raw){
          if(raw === null || raw === undefined) return [];
          return String(raw).split(',').map(function(item){ return item.trim(); }).filter(Boolean);
        }

        function normalizePhotoPath(value){
          if(value === null || value === undefined) return '';
          var str = decodeHtmlEntities(String(value)).trim().replace(/\\/g, '/');
          if(!str) return '';
          if(/^https?:\/\//i.test(str)) return str;
          str = str.replace(/^\/+/, '');
          return str ? '/' + str : '';
        }

        function getFirstPhotoPath(raw){
          const list = parsePhotoList(raw);
          if(!list.length) return '';
          return normalizePhotoPath(list[0]);
        }

        // Copy link buttons (uses current origin so links work on any host)
        document.querySelectorAll('.copy-link').forEach(btn => {
          btn.addEventListener('click', function(){
            const id = this.dataset.id;
            const url = window.location.origin + '/property/' + id;
            navigator.clipboard.writeText(url).then(()=>Swal.fire({title:'Link copied', icon:'success'})).catch(()=>Swal.fire({icon:'error', title:'Copy failed'}));
          });
        });

        // Delete listing
        document.querySelectorAll('.delete-listing').forEach(btn => {
          btn.addEventListener('click', async function(){
            const id = this.dataset.id;
            const card = this.closest('.listing-card');
            const confirmed = await Swal.fire({
              icon:'warning',
              title:'Delete listing?',
              text:'This action cannot be undone.',
              showCancelButton:true,
              confirmButtonText:'Delete',
              confirmButtonColor:'#d33'
            });
            if(!confirmed.isConfirmed) return;
            try{
              Swal.fire({ title:'Deleting...', didOpen: ()=>Swal.showLoading(), allowOutsideClick:false, showConfirmButton:false });
              const res = await fetch(`/api/listing/${id}`, { method:'DELETE' });
              const data = await res.json();
              Swal.close();
              if(data && data.success){
                card?.remove();
                Swal.fire({ icon:'success', title:'Deleted' });
              } else {
                Swal.fire({ icon:'error', title:'Error', text:(data && data.message) || 'Delete failed' });
              }
            }catch(err){
              Swal.close();
              console.error(err);
              Swal.fire({ icon:'error', title:'Network error', text:'Could not delete listing' });
            }
          });
        });

        // Edit listing modal
        const listings = {{{ json listings }}};
        const editModalEl = document.getElementById('editListingModal');
        const editModal = editModalEl ? new bootstrap.Modal(editModalEl) : null;
        const editFields = {
          id: document.getElementById('editListingId'),
          title: document.getElementById('editTitle'),
          price: document.getElementById('editAskingPrice'),
          address: document.getElementById('editAddress'),
          beds: document.getElementById('editBedrooms'),
          baths: document.getElementById('editBathrooms'),
          sqft: document.getElementById('editSqft'),
          photoUrl: document.getElementById('editPhotoURL'),
          photoFiles: document.getElementById('editPhotoFiles'),
          available: document.getElementById('editAvailable'),
          photoPreview: document.getElementById('editPhotoPreview'),
          currentPhotos: document.getElementById('editCurrentPhotos')
        };

        function renderCurrentPhotos(item){
          if(!editFields.currentPhotos) return;
          const container = editFields.currentPhotos;
          container.innerHTML = '';
          const photos = parsePhotoList(item.PhotoFile);
          const fallbackUrl = (item.PhotoURL || '').trim();
          const list = photos.length ? photos : (fallbackUrl ? [fallbackUrl] : []);
          if(!list.length){
            container.innerHTML = '<span class="text-muted small">No photos uploaded yet.</span>';
            return;
          }
          const maxThumbs = 8;
          const frag = document.createDocumentFragment();
          list.slice(0, maxThumbs).forEach(function(raw, idx){
            const src = normalizePhotoPath(raw);
            if(!src) return;
            const wrapper = document.createElement('div');
            wrapper.className = 'd-flex flex-column align-items-center';
            const img = document.createElement('img');
            img.src = src;
            img.style.width = '74px';
            img.style.height = '74px';
            img.style.objectFit = 'cover';
            img.className = 'rounded border shadow-sm';
            wrapper.appendChild(img);
            const caption = document.createElement('div');
            caption.className = 'small text-muted mt-1';
            caption.textContent = `Photo ${idx + 1}`;
            wrapper.appendChild(caption);
            frag.appendChild(wrapper);
          });
          container.appendChild(frag);
          if(list.length > maxThumbs){
            const more = document.createElement('div');
            more.className = 'small text-muted align-self-center';
            more.textContent = `+${list.length - maxThumbs} more saved photo${(list.length - maxThumbs) > 1 ? 's' : ''}`;
            container.appendChild(more);
          }
        }

        document.querySelectorAll('.edit-listing').forEach(btn => {
          btn.addEventListener('click', function(e){
            e.preventDefault();
            if(!editModal) return;
          const id = this.dataset.id || this.href.split('editId=')[1];
          const item = listings.find(x => String(x.listingId) === String(id));
          if(!item){
            Swal.fire({icon:'error', title:'Not found', text:'Listing data missing'});
            return;
          }
          editFields.id.value = item.listingId;
          editFields.title.value = decodeHtmlEntities(item.Title || '');
          editFields.price.value = item.AskingPrice || '';
          editFields.address.value = decodeHtmlEntities(item.PropertyAddress || '');
          editFields.beds.value = item.Bedrooms || '';
          editFields.baths.value = item.Bathrooms || '';
          editFields.sqft.value = item.SquareFootage || item.FloorArea || '';
          editFields.photoUrl.value = decodeHtmlEntities(item.PhotoURL || '');
          editFields.available.checked = !!item.Available;
          renderCurrentPhotos(item);
          if(editFields.photoPreview){
            editFields.photoPreview.innerHTML = '<span class="text-muted small">No new files selected yet.</span>';
          }
          if(editFields.photoFiles){
            editFields.photoFiles.value = '';
            editFields.photoFiles.onchange = function(){
              if(!editFields.photoPreview) return;
              const files = Array.from(this.files || []);
              editFields.photoPreview.innerHTML = '';
              if(!files.length){
                editFields.photoPreview.innerHTML = '<span class="text-muted small">No new files selected yet.</span>';
                return;
              }
              const maxPreview = 6;
              files.slice(0, maxPreview).forEach(function(file, idx){
                const wrapper = document.createElement('div');
                wrapper.className = 'd-flex flex-column align-items-center';
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.style.width = '74px';
                img.style.height = '74px';
                img.style.objectFit = 'cover';
                img.className = 'rounded border shadow-sm';
                wrapper.appendChild(img);
                const meta = document.createElement('div');
                meta.className = 'small text-muted mt-1';
                meta.textContent = file.name.length > 14 ? `${file.name.slice(0, 14)}â€¦` : file.name;
                wrapper.appendChild(meta);
                editFields.photoPreview.appendChild(wrapper);
              });
              if(files.length > maxPreview){
                const more = document.createElement('div');
                more.className = 'small text-muted align-self-center';
                more.textContent = `+${files.length - maxPreview} more selected`;
                editFields.photoPreview.appendChild(more);
              }
            };
          }
          editModal.show();
        });
      });

        document.getElementById('saveListingBtn')?.addEventListener('click', async function(){
          const id = editFields.id.value;
          if(!id) return Swal.fire({icon:'error', title:'Missing ID'});
          const formData = new FormData();
          formData.append('Title', editFields.title.value.trim());
          formData.append('AskingPrice', editFields.price.value !== '' ? editFields.price.value : '');
          formData.append('PropertyAddress', editFields.address.value.trim());
          formData.append('Bedrooms', editFields.beds.value !== '' ? editFields.beds.value : '');
          formData.append('Bathrooms', editFields.baths.value !== '' ? editFields.baths.value : '');
          formData.append('SquareFootage', editFields.sqft.value !== '' ? editFields.sqft.value : '');
          formData.append('PhotoURL', editFields.photoUrl.value.trim());
          formData.append('Available', editFields.available.checked ? 1 : 0);
          if (editFields.photoFiles && editFields.photoFiles.files && editFields.photoFiles.files.length) {
            Array.from(editFields.photoFiles.files).forEach(file => formData.append('PhotoFiles', file));
          }
          try{
            Swal.fire({ title:'Saving...', didOpen: ()=>Swal.showLoading(), allowOutsideClick:false, showConfirmButton:false });
            const res = await fetch(`/api/listing/${id}`, {
              method:'PUT',
              body: formData
            });
            const data = await res.json();
            Swal.close();
            if(data && data.success){
              const item = listings.find(x => String(x.listingId) === String(id));
              if(item){
                Object.assign(item, data.listing || {});
                renderCurrentPhotos(item);
              }
              const card = document.querySelector(`.listing-card[data-id="${id}"]`);
              if(card){
                const listingData = data.listing || {};
                const titleEl = card.querySelector('.listing-title');
                if(titleEl) titleEl.textContent = listingData.Title || '(No title)';
                const priceEl = card.querySelector('.listing-price');
                if(priceEl) priceEl.textContent = listingData.AskingPrice !== null && listingData.AskingPrice !== undefined && listingData.AskingPrice !== '' ? `$${listingData.AskingPrice}` : '$0';
                const addrEl = card.querySelector('.listing-address');
                if(addrEl) addrEl.textContent = listingData.PropertyAddress || '';
                const bedEl = card.querySelector('.listing-bedrooms');
                if(bedEl) bedEl.innerHTML = `<i class="flaticon-bed"></i> ${listingData.Bedrooms ?? ''}`;
                const bathEl = card.querySelector('.listing-bathrooms');
                if(bathEl) bathEl.innerHTML = `<i class="flaticon-bathtub"></i> ${listingData.Bathrooms ?? ''}`;
                const sqftEl = card.querySelector('.listing-sqft');
                if(sqftEl) sqftEl.textContent = (listingData.SquareFootage ? `${listingData.SquareFootage} sqft` : 'N/A');
                const imgEl = card.querySelector('.card-img-element');
                const imgWrapper = card.querySelector('.card-img-left');
                let placeholder = card.querySelector('.card-img-placeholder');
                const newImg = getFirstPhotoPath(listingData.PhotoFile) || listingData.PhotoURL || '';
                if(imgEl){
                  if(newImg){
                    imgEl.src = newImg;
                    imgEl.style.display = 'block';
                    if(placeholder) placeholder.style.display = 'none';
                  } else {
                    imgEl.style.display = 'none';
                    if(!placeholder && imgWrapper){
                      placeholder = document.createElement('div');
                      placeholder.className = 'card-img-placeholder';
                      imgWrapper.appendChild(placeholder);
                    }
                    if(placeholder) placeholder.style.display = 'block';
                  }
                }
                const availBtn = card.querySelector('.availability-btn');
                if(availBtn){
                  const newAvail = listingData.Available ? '1' : '0';
                  availBtn.dataset.available = newAvail;
                  if(listingData.Available){
                    availBtn.classList.remove('btn-outline-secondary');
                    availBtn.classList.add('btn-success');
                    availBtn.textContent = 'Available';
                  } else {
                    availBtn.classList.remove('btn-success');
                    availBtn.classList.add('btn-outline-secondary');
                    availBtn.textContent = 'Unavailable';
                  }
                }
              }
              editModal?.hide();
              Swal.fire({ icon:'success', title:'Saved', timer:1200, showConfirmButton:false });
            } else {
              Swal.fire({ icon:'error', title:'Error', text:(data && data.message) || 'Update failed' });
            }
          }catch(err){
            Swal.close();
            console.error(err);
            Swal.fire({ icon:'error', title:'Network error', text:'Could not save changes' });
          }
        });

        // Availability buttons -> call API to toggle and update UI in-place
        document.querySelectorAll('.availability-btn').forEach(btn => {
          btn.addEventListener('click', async function(){
            const listingId = this.dataset.id;
            const currently = this.dataset.available === 'true' || this.dataset.available === '1' || this.dataset.available === 'True';
            const newAvailable = currently ? 0 : 1;
            const me = this;
            try{
              Swal.fire({ title:'Updating...', didOpen: ()=>Swal.showLoading(), allowOutsideClick:false, showConfirmButton:false });
              const res = await fetch('/api/update-availability', {
                method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ listingId, Available: newAvailable })
              });
              const data = await res.json();
              Swal.close();
              if(data && data.success){
                // update dataset and UI
                me.dataset.available = newAvailable ? '1' : '0';
                if(newAvailable){ me.classList.remove('btn-outline-secondary'); me.classList.add('btn-success'); me.textContent = 'Available'; }
                else { me.classList.remove('btn-success'); me.classList.add('btn-outline-secondary'); me.textContent = 'Unavailable'; }
                Swal.fire({ icon:'success', title:'Saved', text: data.message || 'Availability updated' });
              } else {
                Swal.fire({ icon:'error', title:'Error', text:(data && data.message) || 'Could not update availability' });
              }
            }catch(err){
              Swal.close();
              console.error(err);
              Swal.fire({ icon:'error', title:'Network error', text:'Could not update availability' });
            }
          });
        });

        // Listing detail modal
        document.querySelectorAll('.listing-detail').forEach(btn => {
          btn.addEventListener('click', function(){
            const id = this.dataset.id;
            const item = listings.find(x => String(x.listingId) === String(id));
            if(!item){ Swal.fire({icon:'error', title:'Not found', text:'Listing data missing'}); return; }

            const firstPhoto = getFirstPhotoPath(item.PhotoFile);
            const photoUrl = sanitizeAttribute(item.PhotoURL);
            const image = firstPhoto ? sanitizeAttribute(firstPhoto) : (photoUrl || '');
            let html = '';
            if(image) html += `<div style="text-align:center;margin-bottom:12px;"><img src="${image}" style="max-width:100%;max-height:260px;border-radius:8px;"/></div>`;
            const title = sanitizeDisplay(item.Title || item.PropertyAddress || '');
            html += `<h5>${title}</h5>`;
            html += `<p class="text-muted small">${sanitizeDisplay(item.PropertyAddress || '')}</p>`;
            html += '<table class="table table-sm mt-2"><tbody>';
            const fields = ['Bedrooms','Bathrooms','SquareFootage','AskingPrice','FullName','Email','Phone','Comps1','Comps2','Comps3'];
            fields.forEach(f=>{
              const raw = item[f];
              const val = sanitizeDisplay(raw);
              if(val !== '') html += `<tr><td><strong>${escapeHtml(f)}</strong></td><td>${val}</td></tr>`;
            });
            html += '</tbody></table>';

            Swal.fire({ html, width:'800px', showCloseButton:true, showCancelButton:false, focusConfirm:false, confirmButtonText:'Close' });
          });
        });
      });
    </script>
</body>
</head>
