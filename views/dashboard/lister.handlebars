<head>

<body class="g-sidenav-show bg-gray-100">
  <div class="min-height-300 bg-primary position-absolute w-100"></div>
  {{> __dsidenav}}
  <main class="main-content position-relative border-radius-lg ">
    {{> __dashnavbar}}
    <div class="row g-3">
      {{#each listings}}
      <div class="col-12 mb-3">
        <div class="card h-100 shadow-sm listing-card" data-id="{{this.listingId}}">
          <div class="row g-0 h-100">
            <div class="col-5 col-md-4">
                    <div class="card-img-left">
                      {{#if this.PhotoFile}}
                        <img src="{{firstImage this.PhotoFile}}" alt="{{this.Title}}" class="card-img-element"/>
                      {{else}}
                        {{#if this.PhotoURL}}
                          <img src="{{sanitize this.PhotoURL}}" alt="{{this.Title}}" class="card-img-element"/>
                        {{else}}
                          <div class="card-img-placeholder"></div>
                        {{/if}}
                      {{/if}}
                    </div>
                  </div>
            <div class="col-7 col-md-8">
              <div class="card-body d-flex flex-column h-100">
                <div class="d-flex justify-content-between align-items-start">
                  <h6 class="mb-1 text-truncate listing-title" title="{{this.Title}}">{{this.Title}}</h6>
                  <div class="text-end">
                    <div class="text-primary fw-bold listing-price">${{this.AskingPrice}}</div>
                    <div class="text-muted small listing-arv" {{#unless this.ARV}}style="display:none"{{/unless}}>ARV: ${{formatCurrency this.ARV}}</div>
                    <div class="text-muted small">{{formatDate this.SubmitDate}}</div>
                  </div>
                </div>

                <p class="mb-1 text-muted small text-truncate listing-address">{{this.PropertyAddress}}</p>

                <div class="d-flex gap-2 mb-2 mt-auto align-items-center">
                  <span class="badge bg-info text-dark listing-bedrooms"><i class="flaticon-bed"></i> {{this.Bedrooms}}</span>
                  <span class="badge bg-info text-dark listing-bathrooms"><i class="flaticon-bathtub"></i> {{this.Bathrooms}}</span>
                  <span class="badge bg-light text-muted listing-sqft">{{formatSqft this.SquareFootage this.FloorArea}}</span>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-2">
                  <div class="btn-group flex-wrap" role="group">
                    <button class="btn btn-sm btn-outline-primary listing-detail" data-id="{{this.listingId}}">Details</button>
                    <a class="btn btn-sm btn-outline-secondary" href="tel:{{this.Phone}}">Call</a>
                    <a class="btn btn-sm btn-outline-secondary" href="mailto:{{this.Email}}">Email</a>
                    <a class="btn btn-sm btn-outline-primary edit-listing" data-id="{{this.listingId}}" href="/forms/listing?editId={{this.listingId}}">Edit</a>
                    <button class="btn btn-sm btn-outline-danger delete-listing" data-id="{{this.listingId}}">Delete</button>
                  </div>
                  <div class="d-flex align-items-center">
                    <div class="d-flex align-items-center">
                      <!-- Availability button (AJAX) -->
                      <button
                        class="btn btn-sm availability-btn me-2 {{#if this.Available}}btn-success{{else}}btn-outline-secondary{{/if}}"
                        data-id="{{this.listingId}}"
                        data-available="{{this.Available}}"
                        aria-pressed="false"
                        title="Toggle availability">
                        {{#if this.Available}}Available{{else}}Unavailable{{/if}}
                      </button>

                      {{#if this.IsPro}}
                        <span class="badge bg-warning text-dark me-2">PRO</span>
                      {{/if}}

                      <button class="btn btn-sm btn-primary copy-link" data-id="{{this.listingId}}">Link</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {{/each}}
    </div>

    <style>
      /* Modern small card image */
  .listing-card { border-radius: 12px; overflow: hidden; transition: transform .12s ease, box-shadow .12s ease; display:flex; }
  .listing-card:hover { transform: translateY(-6px); box-shadow: 0 8px 28px rgba(22,28,45,0.12); }
  /* Image column: force cover and keep rounded left corners */
  .card-img-left { width:100%; height:100%; min-height:180px; position:relative; border-top-left-radius:12px; border-bottom-left-radius:12px; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#f6f7fb; }
  /* Use an actual <img> so we can control object-fit and avoid cropping when undesired */
  .card-img-element{ width:100%; height:100%; object-fit:contain; display:block; }
  .card-img-left::after { content: ''; position:absolute; inset:0; pointer-events:none; background:linear-gradient(180deg,rgba(0,0,0,0.0),rgba(0,0,0,0.08)); }
  .card-img-placeholder{ width:100%; height:100%; background:linear-gradient(90deg,#eceef6,#f7f9fc); }
  .text-truncate{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  /* Make title and address use multi-line clamp to avoid awkward truncation */
  .card-body h6{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  .card-body p { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
      .availability-btn{ min-width:96px; }
      .availability-btn.btn-success{ color:#fff; }
      .availability-btn.btn-outline-secondary{ background:transparent; border:1px solid rgba(0,0,0,0.06); }
      .card-body h6{ font-weight:600; }
      .badge.bg-info{ background:#e7f3ff; color:#0b63d6; }
      /* Ensure consistent card height and remove inner gutters */
      .listing-card .row.g-0 { height:100%; }
  .listing-card .col-5, .listing-card .col-7 { padding:0; }
  .listing-card .card-body { padding:14px; }
  .photo-draggable { cursor: grab; }
  .photo-draggable.dragging { opacity: 0.6; }
  .photo-draggable.photo-drag-over { outline: 2px dashed #94a3b8; outline-offset: 2px; border-radius: 10px; }
  @media (max-width:767px){
    .card-img-left{ min-height:160px; }
  }
    </style>

    <!-- Edit Listing Modal -->
    <div class="modal fade" id="editListingModal" tabindex="-1" aria-labelledby="editListingModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editListingModalLabel">Edit Listing</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="editListingForm" novalidate>
              <input type="hidden" id="editListingId">
              <input type="hidden" id="editPhotoFile">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Title</label>
                  <input type="text" class="form-control" id="editTitle" required>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Asking Price</label>
                  <input type="number" class="form-control" id="editAskingPrice" step="0.01">
                </div>
                <div class="col-md-3">
                  <label class="form-label">After Repair Value (ARV)</label>
                  <input type="number" class="form-control" id="editARV" step="0.01" min="0">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Address</label>
                  <input type="text" class="form-control" id="editAddress">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Property Type</label>
                  <input type="text" class="form-control" id="editPropertyType" placeholder="Single Family, Condo, etc.">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Full Name</label>
                  <input type="text" class="form-control" id="editFullName">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-control" id="editEmail">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Phone</label>
                  <input type="text" class="form-control" id="editPhone">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Bedrooms</label>
                  <input type="number" class="form-control" id="editBedrooms" min="0">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Bathrooms</label>
                  <input type="number" class="form-control" id="editBathrooms" min="0">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Square Footage</label>
                  <input type="number" class="form-control" id="editSqft" min="0">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Lot Area</label>
                  <input type="number" class="form-control" id="editLotArea" min="0">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Floor Area</label>
                  <input type="number" class="form-control" id="editFloorArea" min="0">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Year Built</label>
                  <input type="number" class="form-control" id="editYearBuilt" min="0">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Garage</label>
                  <input type="number" class="form-control" id="editGarage" min="0">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Stories</label>
                  <input type="number" class="form-control" id="editStories" min="0">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Roofing</label>
                  <input type="text" class="form-control" id="editRoofing">
                </div>
                <div class="col-12">
                  <label class="form-label" for="editReasonForSelling">Reason For Selling</label>
                  <textarea class="form-control" id="editReasonForSelling" rows="2" placeholder="Add a short reason"></textarea>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Comps 1</label>
                  <input type="text" class="form-control" id="editComps1" placeholder="Link or notes">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Comps 2</label>
                  <input type="text" class="form-control" id="editComps2" placeholder="Link or notes">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Comps 3</label>
                  <input type="text" class="form-control" id="editComps3" placeholder="Link or notes">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Photo URL</label>
                  <input type="text" class="form-control" id="editPhotoURL" placeholder="https://...">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Upload New Photos</label>
                  <input type="file" class="form-control" id="editPhotoFiles" name="PhotoFiles" accept="image/*,.heic,.heif" multiple>
                  <small class="text-muted d-block mt-1">Select up to 60 images to add to this listing.</small>
                  <div id="editPhotoPreview" class="mt-2 d-flex gap-2 flex-wrap"></div>
                </div>
                <div class="col-md-4 d-flex align-items-center">
                  <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="editAvailable">
                    <label class="form-check-label" for="editAvailable">Available</label>
                  </div>
                </div>
                <div class="col-12">
                  <label class="form-label">Current Photos</label>
                  <div id="editCurrentPhotos" class="border rounded p-2 d-flex gap-2 flex-wrap bg-light" style="min-height:90px;">
                    <span class="text-muted small">No photos uploaded yet.</span>
                  </div>
                </div>
                <div class="col-12">
                  <label class="form-label" for="editDescription">Description</label>
                  <textarea class="form-control" id="editDescription" rows="3" placeholder="Add a short description"></textarea>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="saveListingBtn">Save changes</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function(){

        // Client-side sanitizers for modal display
        function decodeHtmlEntities(str){
          if(str === null || str === undefined) return '';
          try{
            var txt = document.createElement('textarea');
            txt.innerHTML = String(str);
            return txt.value;
          } catch(e){ return String(str); }
        }

        function escapeHtml(str){
          return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\"/g, '&quot;')
            .replace(/'/g, '&#39;');
        }

        function sanitizeDisplay(input){
          if(input === null || input === undefined) return '';
          var s = decodeHtmlEntities(input);
          // Normalize backslashes and fullwidth slashes to forward slash
          s = s.replace(/[\\\uFF0F]/g, '/');
          return escapeHtml(s);
        }

        // Use for src/href attribute values (do not HTML-escape here)
        function sanitizeAttribute(input){
          if(input === null || input === undefined) return '';
          var s = decodeHtmlEntities(input);
          s = s.replace(/[\\\uFF0F]/g, '/');
          try{ return encodeURI(s); } catch(e){ return s; }
        }

        function parsePhotoList(raw){
          if(raw === null || raw === undefined) return [];
          return String(raw).split(',').map(function(item){ return item.trim(); }).filter(Boolean);
        }

        function normalizePhotoPath(value){
          if(value === null || value === undefined) return '';
          var str = decodeHtmlEntities(String(value)).trim().replace(/\\/g, '/');
          if(!str) return '';
          if(/^https?:\/\//i.test(str)) return str;
          str = str.replace(/^\/+/, '');
          return str ? '/' + str : '';
        }

        function isHeicFile(file){
          if(!file) return false;
          var name = (file.name || '').toLowerCase();
          var type = (file.type || '').toLowerCase();
          return name.endsWith('.heic') || name.endsWith('.heif') || type.includes('heic') || type.includes('heif');
        }

        async function convertHeicToJpeg(file){
          if(!isHeicFile(file) || !window.heic2any) return file;
          try{
            var blob = await window.heic2any({ blob: file, toType: 'image/jpeg', quality: 0.8 });
            var baseName = (file.name || 'image').replace(/\.(heic|heif)$/i, '');
            return new File([blob], baseName + '.jpg', { type:'image/jpeg', lastModified: Date.now() });
          } catch(e){
            return file;
          }
        }

        function getFirstPhotoPath(raw){
          const list = parsePhotoList(raw);
          if(!list.length) return '';
          return normalizePhotoPath(list[0]);
        }

        // Copy link buttons (uses current origin so links work on any host)
        document.querySelectorAll('.copy-link').forEach(btn => {
          btn.addEventListener('click', function(){
            const id = this.dataset.id;
            const url = window.location.origin + '/property/' + id;
            navigator.clipboard.writeText(url).then(()=>Swal.fire({title:'Link copied', icon:'success'})).catch(()=>Swal.fire({icon:'error', title:'Copy failed'}));
          });
        });

        // Delete listing
        document.querySelectorAll('.delete-listing').forEach(btn => {
          btn.addEventListener('click', async function(){
            const id = this.dataset.id;
            const card = this.closest('.listing-card');
            const confirmed = await Swal.fire({
              icon:'warning',
              title:'Delete listing?',
              text:'This action cannot be undone.',
              showCancelButton:true,
              confirmButtonText:'Delete',
              confirmButtonColor:'#d33'
            });
            if(!confirmed.isConfirmed) return;
            try{
              Swal.fire({ title:'Deleting...', didOpen: ()=>Swal.showLoading(), allowOutsideClick:false, showConfirmButton:false });
              const res = await fetch(`/api/listing/${id}/delete`, { method:'POST', credentials:'same-origin' });
              const data = await res.json();
              Swal.close();
              if(data && data.success){
                card?.remove();
                Swal.fire({ icon:'success', title:'Deleted' });
              } else {
                Swal.fire({ icon:'error', title:'Error', text:(data && data.message) || 'Delete failed' });
              }
            }catch(err){
              Swal.close();
              console.error(err);
              Swal.fire({ icon:'error', title:'Network error', text:'Could not delete listing' });
            }
          });
        });

        // Edit listing modal
        const listings = {{{ json listings }}};
        const editModalEl = document.getElementById('editListingModal');
        const editModal = editModalEl ? new bootstrap.Modal(editModalEl) : null;
        const editFields = {
          id: document.getElementById('editListingId'),
          photoFile: document.getElementById('editPhotoFile'),
          title: document.getElementById('editTitle'),
          price: document.getElementById('editAskingPrice'),
          arv: document.getElementById('editARV'),
          address: document.getElementById('editAddress'),
          propertyType: document.getElementById('editPropertyType'),
          fullName: document.getElementById('editFullName'),
          email: document.getElementById('editEmail'),
          phone: document.getElementById('editPhone'),
          beds: document.getElementById('editBedrooms'),
          baths: document.getElementById('editBathrooms'),
          sqft: document.getElementById('editSqft'),
          lotArea: document.getElementById('editLotArea'),
          floorArea: document.getElementById('editFloorArea'),
          yearBuilt: document.getElementById('editYearBuilt'),
          garage: document.getElementById('editGarage'),
          stories: document.getElementById('editStories'),
          roofing: document.getElementById('editRoofing'),
          reasonForSelling: document.getElementById('editReasonForSelling'),
          comps1: document.getElementById('editComps1'),
          comps2: document.getElementById('editComps2'),
          comps3: document.getElementById('editComps3'),
          photoUrl: document.getElementById('editPhotoURL'),
          photoFiles: document.getElementById('editPhotoFiles'),
          available: document.getElementById('editAvailable'),
          photoPreview: document.getElementById('editPhotoPreview'),
          currentPhotos: document.getElementById('editCurrentPhotos'),
          description: document.getElementById('editDescription')
        };

        const editPhotoState = { files: [] };

        function setEditPhotosFromItem(item){
          editPhotoState.files = parsePhotoList(item?.PhotoFile).map(s => s.trim()).filter(Boolean);
          if(editFields.photoFile) editFields.photoFile.value = editPhotoState.files.join(',');
        }

        function renderCurrentPhotos(){
          if(!editFields.currentPhotos) return;
          const container = editFields.currentPhotos;
          container.innerHTML = '';
          const fallbackUrl = (editFields.photoUrl?.value || '').trim();
          const list = editPhotoState.files.length ? editPhotoState.files.slice() : (fallbackUrl ? [fallbackUrl] : []);
          if(!list.length){
            container.innerHTML = '<span class="text-muted small">No photos uploaded yet.</span>';
            return;
          }
          const frag = document.createDocumentFragment();
          list.forEach(function(raw, idx){
            const src = normalizePhotoPath(raw);
            if(!src) return;
            const wrapper = document.createElement('div');
            wrapper.className = 'position-relative d-flex flex-column align-items-center';
            wrapper.style.width = '78px';
            const img = document.createElement('img');
            img.src = src;
            img.style.width = '74px';
            img.style.height = '74px';
            img.style.objectFit = 'cover';
            img.className = 'rounded border shadow-sm';
            wrapper.appendChild(img);
            if(editPhotoState.files.length){
              wrapper.classList.add('photo-draggable');
              wrapper.draggable = true;
              wrapper.dataset.index = String(idx);
              wrapper.addEventListener('dragstart', function(e){
                try { e.dataTransfer.setData('text/plain', String(idx)); } catch (err) {}
                e.dataTransfer.effectAllowed = 'move';
                wrapper.classList.add('dragging');
              });
              wrapper.addEventListener('dragend', function(){
                wrapper.classList.remove('dragging');
              });
              wrapper.addEventListener('dragover', function(e){
                e.preventDefault();
                wrapper.classList.add('photo-drag-over');
                e.dataTransfer.dropEffect = 'move';
              });
              wrapper.addEventListener('dragleave', function(){
                wrapper.classList.remove('photo-drag-over');
              });
              wrapper.addEventListener('drop', function(e){
                e.preventDefault();
                wrapper.classList.remove('photo-drag-over');
                let from = -1;
                try { from = parseInt(e.dataTransfer.getData('text/plain'), 10); } catch (err) {}
                const to = idx;
                if(!Number.isFinite(from) || from < 0) return;
                if(from === to) return;
                const next = editPhotoState.files.slice();
                const moved = next.splice(from, 1)[0];
                next.splice(to, 0, moved);
                editPhotoState.files = next;
                if(editFields.photoFile) editFields.photoFile.value = editPhotoState.files.join(',');
                renderCurrentPhotos();
              });
            }

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-sm btn-danger';
            removeBtn.textContent = '×';
            removeBtn.setAttribute('aria-label', 'Remove photo');
            removeBtn.style.position = 'absolute';
            removeBtn.style.top = '2px';
            removeBtn.style.right = '2px';
            removeBtn.style.padding = '0 6px';
            removeBtn.style.lineHeight = '1.2';
            removeBtn.addEventListener('click', function(){
              if(editPhotoState.files.length){
                editPhotoState.files.splice(idx, 1);
                if(editFields.photoFile) editFields.photoFile.value = editPhotoState.files.join(',');
                renderCurrentPhotos();
              } else {
                if(editFields.photoUrl) editFields.photoUrl.value = '';
                renderCurrentPhotos();
              }
            });
            wrapper.appendChild(removeBtn);

            const caption = document.createElement('div');
            caption.className = 'small text-muted mt-1';
            caption.textContent = editPhotoState.files.length ? `Photo ${idx + 1}` : 'URL';
            wrapper.appendChild(caption);
            frag.appendChild(wrapper);
          });
          container.appendChild(frag);
        }

        document.querySelectorAll('.edit-listing').forEach(btn => {
          btn.addEventListener('click', function(e){
            e.preventDefault();
            if(!editModal) return;
          const id = this.dataset.id || this.href.split('editId=')[1];
          const item = listings.find(x => String(x.listingId) === String(id));
          if(!item){
            Swal.fire({icon:'error', title:'Not found', text:'Listing data missing'});
            return;
          }
          editFields.id.value = item.listingId;
          editFields.title.value = decodeHtmlEntities(item.Title || '');
          editFields.price.value = item.AskingPrice || '';
          if (editFields.arv) editFields.arv.value = item.ARV || '';
          editFields.address.value = decodeHtmlEntities(item.PropertyAddress || '');
          if (editFields.propertyType) editFields.propertyType.value = decodeHtmlEntities(item.PropertyType || '');
          if (editFields.fullName) editFields.fullName.value = decodeHtmlEntities(item.FullName || '');
          if (editFields.email) editFields.email.value = decodeHtmlEntities(item.Email || '');
          if (editFields.phone) editFields.phone.value = decodeHtmlEntities(item.Phone || '');
          editFields.beds.value = item.Bedrooms || '';
          editFields.baths.value = item.Bathrooms || '';
          editFields.sqft.value = item.SquareFootage || item.FloorArea || '';
          if (editFields.lotArea) editFields.lotArea.value = item.LotArea || '';
          if (editFields.floorArea) editFields.floorArea.value = item.FloorArea || '';
          if (editFields.yearBuilt) editFields.yearBuilt.value = item.YearBuilt || '';
          if (editFields.garage) editFields.garage.value = item.Garage || '';
          if (editFields.stories) editFields.stories.value = item.Stories || '';
          if (editFields.roofing) editFields.roofing.value = decodeHtmlEntities(item.Roofing || '');
          if (editFields.reasonForSelling) editFields.reasonForSelling.value = decodeHtmlEntities(item.ReasonForSelling || '');
          if (editFields.comps1) editFields.comps1.value = decodeHtmlEntities(item.Comps1 || '');
          if (editFields.comps2) editFields.comps2.value = decodeHtmlEntities(item.Comps2 || '');
          if (editFields.comps3) editFields.comps3.value = decodeHtmlEntities(item.Comps3 || '');
          editFields.photoUrl.value = decodeHtmlEntities(item.PhotoURL || '');
          editFields.available.checked = !!item.Available;
          if(editFields.description) editFields.description.value = decodeHtmlEntities(item.Description || '');
          setEditPhotosFromItem(item);
          renderCurrentPhotos();
          if(editFields.photoPreview){
            editFields.photoPreview.innerHTML = '<span class="text-muted small">No new files selected yet.</span>';
          }
          if(editFields.photoFiles){
            editFields.photoFiles.value = '';
            editFields.photoFiles.onchange = async function(){
              if(!editFields.photoPreview) return;
              const rawFiles = Array.from(this.files || []);
              const convertedList = [];
              for(const file of rawFiles){
                convertedList.push(await convertHeicToJpeg(file));
              }
              const dt = new DataTransfer();
              convertedList.forEach(f => f && dt.items.add(f));
              this.files = dt.files;
              const files = Array.from(this.files || []);
              editFields.photoPreview.innerHTML = '';
              if(!files.length){
                editFields.photoPreview.innerHTML = '<span class="text-muted small">No new files selected yet.</span>';
                return;
              }
              const maxPreview = 6;
              files.slice(0, maxPreview).forEach(function(file, idx){
                const wrapper = document.createElement('div');
                wrapper.className = 'd-flex flex-column align-items-center';
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.style.width = '74px';
                img.style.height = '74px';
                img.style.objectFit = 'cover';
                img.className = 'rounded border shadow-sm';
                wrapper.appendChild(img);
                const meta = document.createElement('div');
                meta.className = 'small text-muted mt-1';
                meta.textContent = file.name.length > 14 ? `${file.name.slice(0, 14)}…` : file.name;
                wrapper.appendChild(meta);
                editFields.photoPreview.appendChild(wrapper);
              });
              if(files.length > maxPreview){
                const more = document.createElement('div');
                more.className = 'small text-muted align-self-center';
                more.textContent = `+${files.length - maxPreview} more selected`;
                editFields.photoPreview.appendChild(more);
              }
            };
          }
          editModal.show();
        });
      });

        document.getElementById('saveListingBtn')?.addEventListener('click', async function(){
          const id = editFields.id.value;
          if(!id) return Swal.fire({icon:'error', title:'Missing ID'});
          const formData = new FormData();
          formData.append('Title', editFields.title.value.trim());
          formData.append('AskingPrice', editFields.price.value !== '' ? editFields.price.value : '');
          if (editFields.arv) formData.append('ARV', editFields.arv.value !== '' ? editFields.arv.value : '');
          formData.append('PropertyAddress', editFields.address.value.trim());
          if (editFields.propertyType) formData.append('PropertyType', editFields.propertyType.value.trim());
          if (editFields.fullName) formData.append('FullName', editFields.fullName.value.trim());
          if (editFields.email) formData.append('Email', editFields.email.value.trim());
          if (editFields.phone) formData.append('Phone', editFields.phone.value.trim());
          formData.append('Bedrooms', editFields.beds.value !== '' ? editFields.beds.value : '');
          formData.append('Bathrooms', editFields.baths.value !== '' ? editFields.baths.value : '');
          formData.append('SquareFootage', editFields.sqft.value !== '' ? editFields.sqft.value : '');
          if (editFields.lotArea) formData.append('LotArea', editFields.lotArea.value !== '' ? editFields.lotArea.value : '');
          if (editFields.floorArea) formData.append('FloorArea', editFields.floorArea.value !== '' ? editFields.floorArea.value : '');
          if (editFields.yearBuilt) formData.append('YearBuilt', editFields.yearBuilt.value !== '' ? editFields.yearBuilt.value : '');
          if (editFields.garage) formData.append('Garage', editFields.garage.value !== '' ? editFields.garage.value : '');
          if (editFields.stories) formData.append('Stories', editFields.stories.value !== '' ? editFields.stories.value : '');
          if (editFields.roofing) formData.append('Roofing', editFields.roofing.value.trim());
          if (editFields.reasonForSelling) formData.append('ReasonForSelling', editFields.reasonForSelling.value.trim());
          if (editFields.comps1) formData.append('Comps1', editFields.comps1.value.trim());
          if (editFields.comps2) formData.append('Comps2', editFields.comps2.value.trim());
          if (editFields.comps3) formData.append('Comps3', editFields.comps3.value.trim());
          formData.append('PhotoURL', editFields.photoUrl.value.trim());
          if (editFields.photoFile) formData.append('PhotoFile', editFields.photoFile.value);
          formData.append('Available', editFields.available.checked ? 1 : 0);
          if (editFields.description) {
            formData.append('Description', editFields.description.value.trim());
          }
          if (editFields.photoFiles && editFields.photoFiles.files && editFields.photoFiles.files.length) {
            Array.from(editFields.photoFiles.files).forEach(file => formData.append('PhotoFiles', file));
          }
          try{
            Swal.fire({ title:'Saving...', didOpen: ()=>Swal.showLoading(), allowOutsideClick:false, showConfirmButton:false });
            const res = await fetch(`/api/listing/${id}/update`, {
              method:'POST',
              credentials:'same-origin',
              body: formData
            });
            const data = await res.json();
            Swal.close();
            if(data && data.success){
              const item = listings.find(x => String(x.listingId) === String(id));
              if(item){
                Object.assign(item, data.listing || {});
                setEditPhotosFromItem(item);
                renderCurrentPhotos();
              }
              const card = document.querySelector(`.listing-card[data-id="${id}"]`);
              if(card){
                const listingData = data.listing || {};
                const titleEl = card.querySelector('.listing-title');
                if(titleEl) titleEl.textContent = listingData.Title || '(No title)';
                const priceEl = card.querySelector('.listing-price');
                if(priceEl) priceEl.textContent = listingData.AskingPrice !== null && listingData.AskingPrice !== undefined && listingData.AskingPrice !== '' ? `$${listingData.AskingPrice}` : '$0';
                const arvEl = card.querySelector('.listing-arv');
                const arvRaw = listingData.ARV;
                const arvNum = arvRaw !== null && arvRaw !== undefined && arvRaw !== '' ? Number(arvRaw) : NaN;
                const arvText = (!Number.isNaN(arvNum)) ? `ARV: $${arvNum.toLocaleString('en-US')}` : '';
                if(arvEl){
                  if(arvText){
                    arvEl.textContent = arvText;
                    arvEl.style.display = '';
                  } else {
                    arvEl.textContent = '';
                    arvEl.style.display = 'none';
                  }
                } else if(priceEl) {
                  const holder = document.createElement('div');
                  holder.className = 'text-muted small listing-arv';
                  holder.textContent = arvText;
                  if(!arvText) holder.style.display = 'none';
                  priceEl.insertAdjacentElement('afterend', holder);
                }
                const addrEl = card.querySelector('.listing-address');
                if(addrEl) addrEl.textContent = listingData.PropertyAddress || '';
                const bedEl = card.querySelector('.listing-bedrooms');
                if(bedEl) bedEl.innerHTML = `<i class="flaticon-bed"></i> ${listingData.Bedrooms ?? ''}`;
                const bathEl = card.querySelector('.listing-bathrooms');
                if(bathEl) bathEl.innerHTML = `<i class="flaticon-bathtub"></i> ${listingData.Bathrooms ?? ''}`;
                const sqftEl = card.querySelector('.listing-sqft');
                if(sqftEl) sqftEl.textContent = (listingData.SquareFootage ? `${listingData.SquareFootage} sqft` : 'N/A');
                const imgEl = card.querySelector('.card-img-element');
                const imgWrapper = card.querySelector('.card-img-left');
                let placeholder = card.querySelector('.card-img-placeholder');
                const newImg = getFirstPhotoPath(listingData.PhotoFile) || listingData.PhotoURL || '';
                if(imgEl){
                  if(newImg){
                    imgEl.src = newImg;
                    imgEl.style.display = 'block';
                    if(placeholder) placeholder.style.display = 'none';
                  } else {
                    imgEl.style.display = 'none';
                    if(!placeholder && imgWrapper){
                      placeholder = document.createElement('div');
                      placeholder.className = 'card-img-placeholder';
                      imgWrapper.appendChild(placeholder);
                    }
                    if(placeholder) placeholder.style.display = 'block';
                  }
                }
                const availBtn = card.querySelector('.availability-btn');
                if(availBtn){
                  const newAvail = listingData.Available ? '1' : '0';
                  availBtn.dataset.available = newAvail;
                  if(listingData.Available){
                    availBtn.classList.remove('btn-outline-secondary');
                    availBtn.classList.add('btn-success');
                    availBtn.textContent = 'Available';
                  } else {
                    availBtn.classList.remove('btn-success');
                    availBtn.classList.add('btn-outline-secondary');
                    availBtn.textContent = 'Unavailable';
                  }
                }
              }
              editModal?.hide();
              Swal.fire({ icon:'success', title:'Saved', timer:1200, showConfirmButton:false });
            } else {
              Swal.fire({ icon:'error', title:'Error', text:(data && data.message) || 'Update failed' });
            }
          }catch(err){
            Swal.close();
            console.error(err);
            Swal.fire({ icon:'error', title:'Network error', text:'Could not save changes' });
          }
        });

        // Availability buttons -> call API to toggle and update UI in-place
        document.querySelectorAll('.availability-btn').forEach(btn => {
          btn.addEventListener('click', async function(){
            const listingId = this.dataset.id;
            const currently = this.dataset.available === 'true' || this.dataset.available === '1' || this.dataset.available === 'True';
            const newAvailable = currently ? 0 : 1;
            const me = this;
            try{
              Swal.fire({ title:'Updating...', didOpen: ()=>Swal.showLoading(), allowOutsideClick:false, showConfirmButton:false });
              const res = await fetch('/api/update-availability', {
                method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ listingId, Available: newAvailable })
              });
              const data = await res.json();
              Swal.close();
              if(data && data.success){
                // update dataset and UI
                me.dataset.available = newAvailable ? '1' : '0';
                if(newAvailable){ me.classList.remove('btn-outline-secondary'); me.classList.add('btn-success'); me.textContent = 'Available'; }
                else { me.classList.remove('btn-success'); me.classList.add('btn-outline-secondary'); me.textContent = 'Unavailable'; }
                Swal.fire({ icon:'success', title:'Saved', text: data.message || 'Availability updated' });
              } else {
                Swal.fire({ icon:'error', title:'Error', text:(data && data.message) || 'Could not update availability' });
              }
            }catch(err){
              Swal.close();
              console.error(err);
              Swal.fire({ icon:'error', title:'Network error', text:'Could not update availability' });
            }
          });
        });

        // Listing detail modal
        document.querySelectorAll('.listing-detail').forEach(btn => {
          btn.addEventListener('click', function(){
            const id = this.dataset.id;
            const item = listings.find(x => String(x.listingId) === String(id));
            if(!item){ Swal.fire({icon:'error', title:'Not found', text:'Listing data missing'}); return; }

            const firstPhoto = getFirstPhotoPath(item.PhotoFile);
            const photoUrl = sanitizeAttribute(item.PhotoURL);
            const image = firstPhoto ? sanitizeAttribute(firstPhoto) : (photoUrl || '');
            let html = '';
            if(image) html += `<div style="text-align:center;margin-bottom:12px;"><img src="${image}" style="max-width:100%;max-height:260px;border-radius:8px;"/></div>`;
            const title = sanitizeDisplay(item.Title || item.PropertyAddress || '');
            html += `<h5>${title}</h5>`;
            html += `<p class="text-muted small">${sanitizeDisplay(item.PropertyAddress || '')}</p>`;
            html += '<table class="table table-sm mt-2"><tbody>';
            const fields = ['Bedrooms','Bathrooms','SquareFootage','AskingPrice','ARV','FullName','Email','Phone','Comps1','Comps2','Comps3'];
            fields.forEach(f=>{
              const raw = item[f];
              const val = sanitizeDisplay(raw);
              if(val !== '') html += `<tr><td><strong>${escapeHtml(f)}</strong></td><td>${val}</td></tr>`;
            });
            html += '</tbody></table>';

            Swal.fire({ html, width:'800px', showCloseButton:true, showCancelButton:false, focusConfirm:false, confirmButtonText:'Close' });
          });
        });
      });
    </script>
</body>
</head>
