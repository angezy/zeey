<head>

<body class="g-sidenav-show bg-gray-100">
  <div class="min-height-300 bg-primary position-absolute w-100"></div>
  {{> __dsidenav}}
  <main class="main-content position-relative border-radius-lg ">
    {{> __dashnavbar}}
    <div class="row g-3">
      {{#each listings}}
      <div class="col-12 mb-3">
        <div class="card h-100 shadow-sm listing-card">
          <div class="row g-0 h-100">
            <div class="col-5 col-md-4">
                    <div class="card-img-left">
                      {{#if this.PhotoFile}}
                        <img src="/{{this.PhotoFile}}" alt="{{this.Title}}" class="card-img-element"/>
                      {{else}}
                        <div class="card-img-placeholder"></div>
                      {{/if}}
                    </div>
                  </div>
            <div class="col-7 col-md-8">
              <div class="card-body d-flex flex-column h-100">
                <div class="d-flex justify-content-between align-items-start">
                  <h6 class="mb-1 text-truncate" title="{{this.Title}}">{{this.Title}}</h6>
                  <div class="text-end">
                    <div class="text-primary fw-bold">${{this.AskingPrice}}</div>
                    <div class="text-muted small">{{formatDate this.SubmitDate}}</div>
                  </div>
                </div>

                <p class="mb-1 text-muted small text-truncate">{{this.PropertyAddress}}</p>

                <div class="d-flex gap-2 mb-2 mt-auto align-items-center">
                  <span class="badge bg-info text-dark"><i class="flaticon-bed"></i> {{this.Bedrooms}}</span>
                  <span class="badge bg-info text-dark"><i class="flaticon-bathtub"></i> {{this.Bathrooms}}</span>
                  <span class="badge bg-light text-muted">{{formatSqft this.SquareFootage this.FloorArea}}</span>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-2">
                  <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-outline-primary listing-detail" data-id="{{this.listingId}}">Details</button>
                    <a class="btn btn-sm btn-outline-secondary" href="tel:{{this.ContactPhone}}">Call</a>
                    <a class="btn btn-sm btn-outline-secondary" href="mailto:{{this.ContactEmail}}">Email</a>
                  </div>
                  <div class="d-flex align-items-center">
                    <div class="d-flex align-items-center">
                      <!-- Availability button (AJAX) -->
                      <button
                        class="btn btn-sm availability-btn me-2 {{#if this.Available}}btn-success{{else}}btn-outline-secondary{{/if}}"
                        data-id="{{this.listingId}}"
                        data-available="{{this.Available}}"
                        aria-pressed="false"
                        title="Toggle availability">
                        {{#if this.Available}}Available{{else}}Unavailable{{/if}}
                      </button>

                      {{#if this.IsPro}}
                        <span class="badge bg-warning text-dark me-2">PRO</span>
                      {{/if}}

                      <button class="btn btn-sm btn-primary copy-link" data-id="{{this.listingId}}">Link</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {{/each}}
    </div>

    <style>
      /* Modern small card image */
  .listing-card { border-radius: 12px; overflow: hidden; transition: transform .12s ease, box-shadow .12s ease; display:flex; }
  .listing-card:hover { transform: translateY(-6px); box-shadow: 0 8px 28px rgba(22,28,45,0.12); }
  /* Image column: force cover and keep rounded left corners */
  .card-img-left { width:100%; height:100%; min-height:180px; position:relative; border-top-left-radius:12px; border-bottom-left-radius:12px; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#f6f7fb; }
  /* Use an actual <img> so we can control object-fit and avoid cropping when undesired */
  .card-img-element{ width:100%; height:100%; object-fit:contain; display:block; }
  .card-img-left::after { content: ''; position:absolute; inset:0; pointer-events:none; background:linear-gradient(180deg,rgba(0,0,0,0.0),rgba(0,0,0,0.08)); }
  .card-img-placeholder{ width:100%; height:100%; background:linear-gradient(90deg,#eceef6,#f7f9fc); }
  .text-truncate{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  /* Make title and address use multi-line clamp to avoid awkward truncation */
  .card-body h6{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  .card-body p { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
      .availability-btn{ min-width:96px; }
      .availability-btn.btn-success{ color:#fff; }
      .availability-btn.btn-outline-secondary{ background:transparent; border:1px solid rgba(0,0,0,0.06); }
      .card-body h6{ font-weight:600; }
      .badge.bg-info{ background:#e7f3ff; color:#0b63d6; }
      /* Ensure consistent card height and remove inner gutters */
      .listing-card .row.g-0 { height:100%; }
      .listing-card .col-5, .listing-card .col-7 { padding:0; }
      .listing-card .card-body { padding:14px; }
      @media (max-width:767px){
        .card-img-left{ min-height:160px; }
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function(){

        // Client-side sanitizers for modal display
        function decodeHtmlEntities(str){
          if(str === null || str === undefined) return '';
          try{
            var txt = document.createElement('textarea');
            txt.innerHTML = String(str);
            return txt.value;
          } catch(e){ return String(str); }
        }

        function escapeHtml(str){
          return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\"/g, '&quot;')
            .replace(/'/g, '&#39;');
        }

        function sanitizeDisplay(input){
          if(input === null || input === undefined) return '';
          var s = decodeHtmlEntities(input);
          // Normalize backslashes and fullwidth slashes to forward slash
          s = s.replace(/[\\\uFF0F]/g, '/');
          return escapeHtml(s);
        }

        // Use for src/href attribute values (do not HTML-escape here)
        function sanitizeAttribute(input){
          if(input === null || input === undefined) return '';
          var s = decodeHtmlEntities(input);
          s = s.replace(/[\\\uFF0F]/g, '/');
          try{ return encodeURI(s); } catch(e){ return s; }
        }

        // Copy link buttons (uses current origin so links work on any host)
        document.querySelectorAll('.copy-link').forEach(btn => {
          btn.addEventListener('click', function(){
            const id = this.dataset.id;
            const url = window.location.origin + '/property/' + id;
            navigator.clipboard.writeText(url).then(()=>Swal.fire({title:'Link copied', icon:'success'})).catch(()=>Swal.fire({icon:'error', title:'Copy failed'}));
          });
        });

        // Availability buttons -> call API to toggle and update UI in-place
        document.querySelectorAll('.availability-btn').forEach(btn => {
          btn.addEventListener('click', async function(){
            const listingId = this.dataset.id;
            const currently = this.dataset.available === 'true' || this.dataset.available === '1' || this.dataset.available === 'True';
            const newAvailable = currently ? 0 : 1;
            const me = this;
            try{
              Swal.fire({ title:'Updating...', didOpen: ()=>Swal.showLoading(), allowOutsideClick:false, showConfirmButton:false });
              const res = await fetch('/api/update-availability', {
                method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ listingId, Available: newAvailable })
              });
              const data = await res.json();
              Swal.close();
              if(data && data.success){
                // update dataset and UI
                me.dataset.available = newAvailable ? '1' : '0';
                if(newAvailable){ me.classList.remove('btn-outline-secondary'); me.classList.add('btn-success'); me.textContent = 'Available'; }
                else { me.classList.remove('btn-success'); me.classList.add('btn-outline-secondary'); me.textContent = 'Unavailable'; }
                Swal.fire({ icon:'success', title:'Saved', text: data.message || 'Availability updated' });
              } else {
                Swal.fire({ icon:'error', title:'Error', text:(data && data.message) || 'Could not update availability' });
              }
            }catch(err){
              Swal.close();
              console.error(err);
              Swal.fire({ icon:'error', title:'Network error', text:'Could not update availability' });
            }
          });
        });

        // Listing detail modal
        const listings = {{{ json listings }}};
        document.querySelectorAll('.listing-detail').forEach(btn => {
          btn.addEventListener('click', function(){
            const id = this.dataset.id;
            const item = listings.find(x => String(x.listingId) === String(id));
            if(!item){ Swal.fire({icon:'error', title:'Not found', text:'Listing data missing'}); return; }

            const photoPath = sanitizeAttribute(item.PhotoFile);
            const photoUrl = sanitizeAttribute(item.PhotoURL);
            const image = photoPath ? ('/' + photoPath) : (photoUrl || '');
            let html = '';
            if(image) html += `<div style="text-align:center;margin-bottom:12px;"><img src="${image}" style="max-width:100%;max-height:260px;border-radius:8px;"/></div>`;
            const title = sanitizeDisplay(item.Title || item.PropertyAddress || '');
            html += `<h5>${title}</h5>`;
            html += `<p class="text-muted small">${sanitizeDisplay(item.PropertyAddress || '')}</p>`;
            html += '<table class="table table-sm mt-2"><tbody>';
            const fields = ['Bedrooms','Bathrooms','SquareFootage','AskingPrice','FullName','Email','Phone','Comps1','Comps2','Comps3'];
            fields.forEach(f=>{
              const raw = item[f];
              const val = sanitizeDisplay(raw);
              if(val !== '') html += `<tr><td><strong>${escapeHtml(f)}</strong></td><td>${val}</td></tr>`;
            });
            html += '</tbody></table>';

            Swal.fire({ html, width:'800px', showCloseButton:true, showCancelButton:false, focusConfirm:false, confirmButtonText:'Close' });
          });
        });
      });
    </script>
</body>
</head>